library Delivery;

uses
  System.SysUtils,
  System.Classes,
  Vcl.Forms,
  Winapi.Windows,
  FireDAC.Comp.Client,
  cxButtons,
  DeliveryUnit in 'DeliveryUnit.pas' {fmDelivery},
  LinkConnectionUnit in '..\..\..\BackOffice_new\PLAGINS\LinkConnectionUnit.pas';

{$R *.res}

var
  PrevApplication : TApplication;
  PrevScreen : TScreen;
procedure DLLMain(EntryCode: integer);
begin
  case EntryCode of
    DLL_PROCESS_ATTACH:
    begin
      // Do Initialization stuff here. Called when a process loads the DLL
      PrevApplication := Application;
      PrevScreen := Screen;
    end;
    DLL_PROCESS_DETACH:
    begin
      // Do Finalization stuff here. Called when a process unloads the DLL
       FreeLibrary (HInstance);
      Application := PrevApplication;
      Screen := PrevScreen;
    end;
  end;
end;

function GetGroup:String; export;
begin
  result:='Îïåðàöèè';
end;

function GetName:String; export;
begin
  result:='ÄÎÑÒÀÂÊÀ';
end;

function GetMDIName:String; export;
 begin
   result:='fmDelivery';
 end;

function LoadDLLForm(ATApp : TApplication; S: TScreen; D:TFDConnection; ID:Integer):THandle; export;
var i:Integer;
begin
 for i := 0 to ATApp.ComponentCount - 1 do
   if ATApp.Components[i].ClassName = 'TDM' then
    begin
      DUID:=TFDQuery(TDataModule(ATApp.Components[i]).FindComponent('Current_order')).FieldByName('UID').AsString;
      break;
    end;
  if DUID = '' then
   exit;
  Application:= ATApp;
  Screen := S;
  fdb:=D;
  fmDelivery:=TfmDelivery.Create(Application.MainForm);
  Result:=fmDelivery.Handle;
  if fmDelivery.ShowModal = 1 then
   begin
   //  if TForm(FindControl(Application.ActiveFormHandle)).Name = 'fmDeliv' then

     TcxButton(Application.MainForm.FindComponent('PayButton')).Tag:=1;
     TcxButton(Application.MainForm.FindComponent('PayButton')).Click;
   end
  else TcxButton(Application.MainForm.FindComponent('PayButton')).Tag:=0;

end;

exports LoadDLLForm, GetGroup, GetName, GetMDIName;

begin
DLLProc := @DLLMain;
DLLMain(DLL_PROCESS_ATTACH);
end.
